<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理員後台 - 訂單管理</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 2em;
      color: #2c3e50;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .controls-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
    }

    .controls-row {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #3F51B5;
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: #3F51B5;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .filter-select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      min-width: 150px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #3F51B5, #303F9F);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
    }

    .btn-success {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .order-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      border-left: 5px solid #3F51B5;
    }

    .order-card:hover {
      transform: translateY(-5px);
    }

    .order-header {
      background: linear-gradient(135deg, #3F51B5 0%, #303F9F 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-info {
      flex: 1;
    }

    .order-id {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .order-date {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .order-status {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .order-body {
      padding: 20px;
    }

    .member-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .member-info {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .member-id {
      font-size: 0.9em;
      color: #666;
    }

    .order-items {
      margin-bottom: 15px;
    }

    .items-title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 3px;
    }

    .item-price {
      color: #e74c3c;
      font-size: 0.9em;
    }

    .item-quantity {
      background: #e9ecef;
      padding: 3px 8px;
      border-radius: 15px;
      font-weight: bold;
      margin: 0 10px;
      min-width: 30px;
      text-align: center;
      font-size: 0.9em;
    }

    .order-summary {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-row:last-child {
      margin-bottom: 0;
      font-weight: bold;
      font-size: 1.1em;
      color: #2c3e50;
      border-top: 1px solid #dee2e6;
      padding-top: 8px;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    .status-message {
      margin-bottom: 20px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      display: none;
      text-align: center;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.2em;
      grid-column: 1 / -1;
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 150px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.8em;
      font-weight: bold;
      color: #2c3e50;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* 編輯模態框樣式 */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #3F51B5;
    }

    .form-input:read-only {
      background-color: #f8f9fa;
      color: #666;
    }

    .order-details-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .details-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .detail-item:last-child {
      margin-bottom: 0;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        min-width: auto;
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }

      .stats-row {
        flex-direction: column;
      }

      .order-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .order-actions {
        justify-content: center;
      }

      .modal-content {
        margin: 20px 10px;
        width: calc(100% - 20px);
      }

      .modal-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="page-title">
      <span>📋</span>
      訂單管理系統
    </h1>
    <a href="admin-dashboard.html" class="back-btn">
      ← 返回主控台
    </a>
  </div>

  <div id="statusMessage" class="status-message"></div>

  <div class="controls-section">
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-number" id="totalOrders">0</div>
        <div class="stat-label">總訂單數</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalRevenue">0</div>
        <div class="stat-label">總營業額</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalCustomers">0</div>
        <div class="stat-label">購買會員數</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgOrderValue">0</div>
        <div class="stat-label">平均訂單金額</div>
      </div>
    </div>

    <div class="controls-row">
      <div class="search-box">
        <input type="text" class="search-input" placeholder="搜尋訂單ID或會員ID..." id="orderSearchInput">
        <button class="search-btn" onclick="searchOrders()">🔍</button>
      </div>
      <select class="filter-select" id="memberFilter" onchange="filterByMember()">
        <option value="">所有會員</option>
      </select>
      <select class="filter-select" id="dateFilter" onchange="filterByDate()">
        <option value="">所有日期</option>
        <option value="today">今天</option>
        <option value="week">本週</option>
        <option value="month">本月</option>
      </select>
      <button class="btn btn-secondary" onclick="refreshOrders()">
        🔄 重新整理
      </button>
    </div>
  </div>

  <div class="orders-grid" id="ordersGrid">
    <div class="no-data">
      <div class="loading-spinner"></div>
      載入訂單資料中...
    </div>
  </div>
</div>

<!-- 編輯訂單模態框 -->
<div class="edit-modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header" id="modalTitle">編輯訂單</div>
    <form id="editForm">
      <div class="form-group">
        <label class="form-label" for="editOrderId">訂單編號</label>
        <input type="number" class="form-input" id="editOrderId" readonly>
      </div>
      <div class="form-group">
        <label class="form-label" for="editMemberId">會員ID</label>
        <input type="number" class="form-input" id="editMemberId" readonly>
      </div>
      <div class="form-group">
        <label class="form-label" for="editOrderDate">訂單日期</label>
        <input type="datetime-local" class="form-input" id="editOrderDate">
      </div>
      
      <div class="order-details-section">
        <div class="details-title">訂單明細</div>
        <div id="editOrderDetails"></div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
        <button type="submit" class="btn btn-primary">更新訂單</button>
      </div>
    </form>
  </div>
</div>

<script>
  // API設定
  const API_CONFIG = {
    baseURL: 'https://intellij-project1-production.up.railway.app',
    endpoints: {
      orders: '/user/orders',
      products: '/user/products',
      members: '/user/members'
    }
  };

  // 全域變數
  let ordersData = [];
  let filteredOrders = [];
  let productsData = [];
  let membersData = [];
  let currentEditOrder = null;
  let currentAdminLevel = null; // 當前管理員權限等級

  // 顯示狀態訊息
  function showMessage(message, type = 'success') {
    const messageElement = document.getElementById('statusMessage');
    messageElement.textContent = message;
    messageElement.className = `status-message ${type}`;
    messageElement.style.display = 'block';

    if (type !== 'loading') {
      setTimeout(() => {
        messageElement.style.display = 'none';
      }, 4000);
    }
  }

  // 載入所有訂單資料
  async function loadOrders() {
    try {
      showMessage('載入訂單資料中...', 'loading');
      
      // 先載入會員列表和商品列表
      await Promise.all([loadMembers(), loadProducts()]);
      
      // 直接呼叫管理員API獲取所有訂單資料
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('adminToken') || ''}`
        }
      });

      if (response.ok) {
        const result = await response.json();
        const allOrderData = result.data || result || [];
        
        // 將訂單資料按order_id分組，處理包含訂單詳細的結構
        const ordersByOrderId = {};
        
        allOrderData.forEach(item => {
          const orderId = item.order_id;
          
          if (!ordersByOrderId[orderId]) {
            // 創建新的訂單記錄
            ordersByOrderId[orderId] = {
              order_id: orderId,
              member_id: item.member_id,
              create_at: item.create_at || new Date().toISOString(),
              orderDetails: []
            };
          }
          
          // 如果有商品資訊，添加到訂單明細中
          if (item.product_id) {
            ordersByOrderId[orderId].orderDetails.push({
              order_id: orderId,
              product_id: item.product_id,
              quantity: item.quantity || 1,
              price: item.price || 0
            });
          }
        });

        ordersData = Object.values(ordersByOrderId);
        filteredOrders = [...ordersData];
        renderOrdersGrid();
        updateStats();
        showMessage(`載入完成，共 ${ordersData.length} 筆訂單`, 'success');
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      console.error('載入訂單資料錯誤:', error);
      
      // 載入測試資料
      loadTestData();
      showMessage('連接後端失敗，載入測試資料', 'error');
    }
  }

  // 載入所有訂單的詳細資料
  async function loadAllOrderDetails() {
    for (let order of ordersData) {
      try {
        // 使用新的API結構：GET /user/orders?order_id=123 返回訂單明細
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}?order_id=${order.order_id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          // 根據新的API，這裡直接返回order_detail陣列
          order.orderDetails = result.data || [];
        }
      } catch (error) {
        console.warn(`無法載入訂單 ${order.order_id} 的詳細資料:`, error);
        order.orderDetails = [];
      }
    }
  }

  // 載入特定會員的訂單
  async function loadOrdersByMember(memberId) {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}?member_id=${memberId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        return result.data || [];
      } else {
        throw new Error('無法載入會員訂單資料');
      }
    } catch (error) {
      console.error(`載入會員 ${memberId} 訂單資料錯誤:`, error);
      return [];
    }
  }

  // 載入會員資料
  async function loadMembers() {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.members}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        membersData = result.data || result || [];
        renderMemberFilter();
      }
    } catch (error) {
      console.error('載入會員資料錯誤:', error);
      // 使用測試會員資料
      membersData = [
        { member_id: 111, name: '張小明' },
        { member_id: 222, name: '李小美' },
        { member_id: 333, name: '王大華' }
      ];
      renderMemberFilter();
    }
  }

  // 載入商品資料
  async function loadProducts() {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.products}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        productsData = result.data || result || [];
      }
    } catch (error) {
      console.error('載入商品資料錯誤:', error);
      // 使用測試商品資料
      productsData = [
        { product_id: 1, name: 'iPhone 15 Pro', price: 39900 },
        { product_id: 2, name: '無線耳機', price: 2990 },
        { product_id: 3, name: '運動鞋', price: 3500 },
        { product_id: 4, name: '咖啡機', price: 12800 }
      ];
    }
  }

  // 載入測試資料
  function loadTestData() {
    ordersData = [
      {
        order_id: 1001,
        member_id: 111,
        create_at: '2024-01-15T10:30:00',
        orderDetails: [
          { order_id: 1001, product_id: 1, quantity: 1, price: 39900 },
          { order_id: 1001, product_id: 2, quantity: 2, price: 2990 }
        ]
      },
      {
        order_id: 1002,
        member_id: 222,
        create_at: '2024-01-16T14:20:00',
        orderDetails: [
          { order_id: 1002, product_id: 3, quantity: 1, price: 3500 },
          { order_id: 1002, product_id: 4, quantity: 1, price: 12800 }
        ]
      },
      {
        order_id: 1003,
        member_id: 111,
        create_at: '2024-01-17T09:15:00',
        orderDetails: [
          { order_id: 1003, product_id: 1, quantity: 2, price: 39900 }
        ]
      }
    ];
    filteredOrders = [...ordersData];
    renderOrdersGrid();
    updateStats();
  }

  // 渲染訂單網格
  function renderOrdersGrid() {
    const grid = document.getElementById('ordersGrid');
    
    if (filteredOrders.length === 0) {
      grid.innerHTML = `
        <div class="no-data">沒有找到符合條件的訂單</div>
      `;
      return;
    }

    grid.innerHTML = filteredOrders.map(order => {
      const member = getMemberInfo(order.member_id);
      const orderTotal = calculateOrderTotal(order);
      const itemCount = order.orderDetails?.length || 0;
      
      const orderItemsHtml = (order.orderDetails || []).map(detail => {
        const product = getProductInfo(detail.product_id);
        const itemTotal = detail.price * detail.quantity;
        return `
          <div class="order-item">
            <div class="item-info">
              <div class="item-name">${product.name}</div>
              <div class="item-price">單價: NT$ ${formatPrice(detail.price)}</div>
            </div>
            <div class="item-quantity">x${detail.quantity}</div>
            <div style="text-align: right; font-weight: bold; color: #e74c3c; min-width: 100px;">
              NT$ ${formatPrice(itemTotal)}
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-info">
              <div class="order-id">訂單 #${order.order_id}</div>
              <div class="order-date">${formatDate(order.create_at)}</div>
            </div>
            <div class="order-status">已完成</div>
          </div>
          <div class="order-body">
            <div class="member-section">
              <div class="member-info">${member.name}</div>
              <div class="member-id">會員ID: ${order.member_id}</div>
            </div>
            
            <div class="order-items">
              <div class="items-title">
                <span>📦</span>
                訂單明細 (${itemCount} 項商品)
              </div>
              ${orderItemsHtml}
            </div>
            
            <div class="order-summary">
              <div class="summary-row">
                <span>商品小計:</span>
                <span>NT$ ${formatPrice(orderTotal)}</span>
              </div>
              <div class="summary-row">
                <span>運費:</span>
                <span>NT$ 0</span>
              </div>
              <div class="summary-row">
                <span>訂單總計:</span>
                <span>NT$ ${formatPrice(orderTotal)}</span>
              </div>
            </div>
            
            <div class="order-actions">
              <button class="btn btn-primary btn-sm" onclick="editOrder(${order.order_id})">
                ✏️ 編輯
              </button>
              <button class="btn btn-success btn-sm" onclick="viewOrderDetails(${order.order_id})">
                👁️ 詳細
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.order_id})">
                🗑️ 刪除
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // 渲染會員篩選器
  function renderMemberFilter() {
    const select = document.getElementById('memberFilter');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">所有會員</option>' +
      membersData.map(member => 
        `<option value="${member.member_id}">會員${member.member_id} - ${member.name || ''}</option>`
      ).join('');
    
    select.value = currentValue;
  }

  // 取得會員資訊
  function getMemberInfo(memberId) {
    const member = membersData.find(m => m.member_id === memberId);
    return member || { name: `會員${memberId}`, member_id: memberId };
  }

  // 取得商品資訊
  function getProductInfo(productId) {
    const product = productsData.find(p => p.product_id === productId);
    return product || { name: `商品${productId}`, price: 0 };
  }

  // 計算訂單總金額
  function calculateOrderTotal(order) {
    if (!order.orderDetails) return 0;
    return order.orderDetails.reduce((total, detail) => {
      return total + (detail.price * detail.quantity);
    }, 0);
  }

  // 格式化價格
  function formatPrice(price) {
    return new Intl.NumberFormat('zh-TW').format(price);
  }

  // 格式化日期
  function formatDate(dateString) {
    if (!dateString) return '未知';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW');
  }

  // 更新統計資料
  function updateStats() {
    const totalOrders = ordersData.length;
    const totalRevenue = ordersData.reduce((sum, order) => sum + calculateOrderTotal(order), 0);
    const uniqueCustomers = new Set(ordersData.map(order => order.member_id)).size;
    const avgOrderValue = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;

    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('totalRevenue').textContent = formatPrice(totalRevenue);
    document.getElementById('totalCustomers').textContent = uniqueCustomers;
    document.getElementById('avgOrderValue').textContent = formatPrice(avgOrderValue);
  }

  // 搜尋訂單
  function searchOrders() {
    const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
    applyFilters();
  }

  // 依會員篩選
  function filterByMember() {
    applyFilters();
  }

  // 依日期篩選
  function filterByDate() {
    applyFilters();
  }

  // 應用所有篩選
  function applyFilters() {
    const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
    const memberFilter = document.getElementById('memberFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;

    filteredOrders = ordersData.filter(order => {
      // 搜尋篩選
      const matchesSearch = !searchTerm || 
        order.order_id.toString().includes(searchTerm) ||
        order.member_id.toString().includes(searchTerm);

      // 會員篩選
      const matchesMember = !memberFilter || 
        order.member_id.toString() === memberFilter;

      // 日期篩選
      let matchesDate = true;
      if (dateFilter && order.create_at) {
        const orderDate = new Date(order.create_at);
        const now = new Date();
        
        switch (dateFilter) {
          case 'today':
            matchesDate = orderDate.toDateString() === now.toDateString();
            break;
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            matchesDate = orderDate >= weekAgo;
            break;
          case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            matchesDate = orderDate >= monthAgo;
            break;
        }
      }

      return matchesSearch && matchesMember && matchesDate;
    });

    renderOrdersGrid();
    showMessage(`找到 ${filteredOrders.length} 筆符合條件的訂單`, 'success');
  }

  // 重新整理訂單資料
  function refreshOrders() {
    document.getElementById('orderSearchInput').value = '';
    document.getElementById('memberFilter').value = '';
    document.getElementById('dateFilter').value = '';
    loadOrders();
  }

  // 編輯訂單
  function editOrder(orderId) {

    // 檢查權限
    if (!checkOperationPermission()) {
      return;
    }

    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    currentEditOrder = order;
    
    document.getElementById('editOrderId').value = order.order_id;
    document.getElementById('editMemberId').value = order.member_id;
    
    // 格式化日期為 datetime-local 格式
    if (order.create_at) {
      const date = new Date(order.create_at);
      const formatted = date.toISOString().slice(0, 16);
      document.getElementById('editOrderDate').value = formatted;
    }
    
    // 渲染訂單明細
    renderEditOrderDetails(order.orderDetails || []);
    
    document.getElementById('editModal').style.display = 'flex';
  }

  // 渲染編輯模態框中的訂單明細
  function renderEditOrderDetails(orderDetails) {
    const container = document.getElementById('editOrderDetails');
    
    if (orderDetails.length === 0) {
      container.innerHTML = '<div style="text-align: center; color: #666;">此訂單沒有商品明細</div>';
      return;
    }
    
    container.innerHTML = orderDetails.map((detail, index) => {
      const product = getProductInfo(detail.product_id);
      return `
        <div class="detail-item">
          <div style="flex: 1;">
            <strong>${product.name}</strong><br>
            <small>商品ID: ${detail.product_id}</small>
          </div>
          <div style="text-align: center;">
            <label>數量:</label>
            <input type="number" value="${detail.quantity}" min="1" 
                   onchange="updateDetailQuantity(${index}, this.value)"
                   style="width: 60px; margin-left: 5px;">
          </div>
          <div style="text-align: right;">
            NT$ ${formatPrice(detail.price)}
          </div>
        </div>
      `;
    }).join('');
  }

  // 更新訂單明細數量
  function updateDetailQuantity(index, newQuantity) {

    // 檢查權限
    if (!checkOperationPermission()) {
      return;
    }

    if (currentEditOrder && currentEditOrder.orderDetails[index]) {
      currentEditOrder.orderDetails[index].quantity = parseInt(newQuantity);
    }
  }

  // 關閉編輯模態框
  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditOrder = null;
  }

  // 更新訂單
  async function updateOrder(event) {

    // 檢查權限
    if (!checkOperationPermission()) {
      return;
    }

    event.preventDefault();
    
    if (!currentEditOrder) return;
    
    try {
      showMessage('更新訂單中...', 'loading');
      
      const updateData = {
        order_id: currentEditOrder.order_id,
        member_id: currentEditOrder.member_id,
        create_at: document.getElementById('editOrderDate').value,
        orderDetails: currentEditOrder.orderDetails
      };
      
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      });

      if (response.ok) {
        closeEditModal();
        loadOrders(); // 重新載入資料
        showMessage('訂單更新成功', 'success');
      } else {
        throw new Error('更新失敗');
      }
    } catch (error) {
      console.error('更新訂單錯誤:', error);
      showMessage('更新訂單失敗，請稍後再試', 'error');
    }
  }

  // 查看訂單詳細
  function viewOrderDetails(orderId) {
    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    const member = getMemberInfo(order.member_id);
    const orderTotal = calculateOrderTotal(order);
    
    let detailsText = `訂單編號: ${order.order_id}\n`;
    detailsText += `會員: ${member.name} (ID: ${order.member_id})\n`;
    detailsText += `訂單日期: ${formatDate(order.create_at)}\n\n`;
    detailsText += `商品明細:\n`;
    
    (order.orderDetails || []).forEach(detail => {
      const product = getProductInfo(detail.product_id);
      detailsText += `- ${product.name} x${detail.quantity} = NT$ ${formatPrice(detail.price * detail.quantity)}\n`;
    });
    
    detailsText += `\n訂單總計: NT$ ${formatPrice(orderTotal)}`;
    
    alert(detailsText);
  }

  // 刪除訂單
  async function deleteOrder(orderId) {

    // 檢查權限
    if (!checkOperationPermission()) {
      return;
    }

    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    if (confirm(`確定要刪除訂單 #${orderId} 嗎？此操作無法復原。`)) {
      try {
        showMessage('刪除訂單中...', 'loading');
        
        const deleteData = {
          order_id: orderId
        };
        
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(deleteData)
        });

        if (response.ok) {
          loadOrders(); // 重新載入資料
          showMessage('訂單刪除成功', 'success');
        } else {
          throw new Error('刪除失敗');
        }
      } catch (error) {
        console.error('刪除訂單錯誤:', error);
        showMessage('刪除訂單失敗，請稍後再試', 'error');
      }
    }
  }

  // 檢查管理員權限
  function checkAdminAuth() {
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      showMessage('請先登入管理員帳號', 'error');
      setTimeout(() => {
        window.location.href = 'admin-login.html';
      }, 2000);
      return false;
    }

    // 獲取管理員權限等級
    const adminInfo = localStorage.getItem('adminInfo');
    const adminLevel = localStorage.getItem('adminLevel');

    console.log('localStorage內容檢查:');
    console.log('adminToken:', adminToken);
    console.log('adminInfo:', adminInfo);
    console.log('adminLevel:', adminLevel);

    // 嘗試多種方式獲取管理員等級
    if (adminInfo) {
      try {
        const info = JSON.parse(adminInfo);
        console.log('解析的adminInfo:', info);
        currentAdminLevel = info.level !== undefined ? info.level : (info.adminLevel !== undefined ? info.adminLevel : null);
      } catch (error) {
        console.warn('無法解析管理員資訊:', error);
        currentAdminLevel = null;
      }
    }

    // 如果adminInfo沒有level，嘗試從單獨的adminLevel項目取得
    if (currentAdminLevel === null && adminLevel !== null) {
      currentAdminLevel = parseInt(adminLevel);
    }

    // 如果還是沒有，暫時設為測試等級（可移除）
    if (currentAdminLevel === null) {
      console.warn('無法從localStorage獲取管理員等級，請檢查登入流程');
      // 臨時設置為測試用（實際使用時應移除）
      currentAdminLevel = 0; // 暫時設為超級管理員以便測試
      showMessage('警告：無法確認管理員等級，暫時設為超級管理員', 'error');
    }

    console.log('最終設定的currentAdminLevel:', currentAdminLevel);

    return true;
  }

  // 檢查操作權限
  function checkOperationPermission() {
    if (currentAdminLevel === null) {
      showMessage('無法確認管理員權限等級', 'error');
      return false;
    }

    // 只有等級 0-2 的管理員可以進行編輯和刪除操作
    if (currentAdminLevel > 2) {
      showMessage('權限不足', 'error');
      return false;
    }

    return true;
  }

  // 搜尋輸入框回車事件
  document.getElementById('orderSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      searchOrders();
    }
  });

  // 表單提交事件
  document.getElementById('editForm').addEventListener('submit', updateOrder);

  // 點擊模態框外部關閉
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });

  // 頁面載入完成後檢查權限並載入資料
  window.addEventListener('load', function() {
    if (checkAdminAuth()) {
      loadProducts();
      loadMembers();
      loadOrders();
    }
  });

  // 錯誤處理
  window.addEventListener('error', function(e) {
    console.error('頁面錯誤:', e.error);
  });
</script>
</body>
</html>