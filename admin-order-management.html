<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å“¡å¾Œå° - è¨‚å–®ç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 2em;
      color: #2c3e50;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .back-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .controls-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
    }

    .controls-row {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #3F51B5;
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      background: #3F51B5;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .filter-select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      min-width: 150px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #3F51B5, #303F9F);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
    }

    .btn-success {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .order-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease;
      border-left: 5px solid #3F51B5;
    }

    .order-card:hover {
      transform: translateY(-5px);
    }

    .order-header {
      background: linear-gradient(135deg, #3F51B5 0%, #303F9F 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-info {
      flex: 1;
    }

    .order-id {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .order-date {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .order-status {
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .order-body {
      padding: 20px;
    }

    .member-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .member-info {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .member-id {
      font-size: 0.9em;
      color: #666;
    }

    .order-items {
      margin-bottom: 15px;
    }

    .items-title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 3px;
    }

    .item-price {
      color: #e74c3c;
      font-size: 0.9em;
    }

    .item-quantity {
      background: #e9ecef;
      padding: 3px 8px;
      border-radius: 15px;
      font-weight: bold;
      margin: 0 10px;
      min-width: 30px;
      text-align: center;
      font-size: 0.9em;
    }

    .order-summary {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-row:last-child {
      margin-bottom: 0;
      font-weight: bold;
      font-size: 1.1em;
      color: #2c3e50;
      border-top: 1px solid #dee2e6;
      padding-top: 8px;
    }

    .order-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    .status-message {
      margin-bottom: 20px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      display: none;
      text-align: center;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.2em;
      grid-column: 1 / -1;
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 150px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.8em;
      font-weight: bold;
      color: #2c3e50;
    }

    .stat-label {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }

    /* ç·¨è¼¯æ¨¡æ…‹æ¡†æ¨£å¼ */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #3F51B5;
    }

    .form-input:read-only {
      background-color: #f8f9fa;
      color: #666;
    }

    .order-details-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .details-title {
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .detail-item:last-child {
      margin-bottom: 0;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        min-width: auto;
      }

      .orders-grid {
        grid-template-columns: 1fr;
      }

      .stats-row {
        flex-direction: column;
      }

      .order-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }

      .order-actions {
        justify-content: center;
      }

      .modal-content {
        margin: 20px 10px;
        width: calc(100% - 20px);
      }

      .modal-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="page-title">
      <span>ğŸ“‹</span>
      è¨‚å–®ç®¡ç†ç³»çµ±
    </h1>
    <a href="admin-dashboard.html" class="back-btn">
      â† è¿”å›ä¸»æ§å°
    </a>
  </div>

  <div id="statusMessage" class="status-message"></div>

  <div class="controls-section">
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-number" id="totalOrders">0</div>
        <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalRevenue">0</div>
        <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalCustomers">0</div>
        <div class="stat-label">è³¼è²·æœƒå“¡æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgOrderValue">0</div>
        <div class="stat-label">å¹³å‡è¨‚å–®é‡‘é¡</div>
      </div>
    </div>

    <div class="controls-row">
      <div class="search-box">
        <input type="text" class="search-input" placeholder="æœå°‹è¨‚å–®IDæˆ–æœƒå“¡ID..." id="orderSearchInput">
        <button class="search-btn" onclick="searchOrders()">ğŸ”</button>
      </div>
      <select class="filter-select" id="memberFilter" onchange="filterByMember()">
        <option value="">æ‰€æœ‰æœƒå“¡</option>
      </select>
      <select class="filter-select" id="dateFilter" onchange="filterByDate()">
        <option value="">æ‰€æœ‰æ—¥æœŸ</option>
        <option value="today">ä»Šå¤©</option>
        <option value="week">æœ¬é€±</option>
        <option value="month">æœ¬æœˆ</option>
      </select>
      <button class="btn btn-secondary" onclick="refreshOrders()">
        ğŸ”„ é‡æ–°æ•´ç†
      </button>
    </div>
  </div>

  <div class="orders-grid" id="ordersGrid">
    <div class="no-data">
      <div class="loading-spinner"></div>
      è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...
    </div>
  </div>
</div>

<!-- ç·¨è¼¯è¨‚å–®æ¨¡æ…‹æ¡† -->
<div class="edit-modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header" id="modalTitle">ç·¨è¼¯è¨‚å–®</div>
    <form id="editForm">
      <div class="form-group">
        <label class="form-label" for="editOrderId">è¨‚å–®ç·¨è™Ÿ</label>
        <input type="number" class="form-input" id="editOrderId" readonly>
      </div>
      <div class="form-group">
        <label class="form-label" for="editMemberId">æœƒå“¡ID</label>
        <input type="number" class="form-input" id="editMemberId" readonly>
      </div>
      <div class="form-group">
        <label class="form-label" for="editOrderDate">è¨‚å–®æ—¥æœŸ</label>
        <input type="datetime-local" class="form-input" id="editOrderDate">
      </div>
      
      <div class="order-details-section">
        <div class="details-title">è¨‚å–®æ˜ç´°</div>
        <div id="editOrderDetails"></div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">æ›´æ–°è¨‚å–®</button>
      </div>
    </form>
  </div>
</div>

<script>
  // APIè¨­å®š
  const API_CONFIG = {
    baseURL: 'https://intellij-project1-production.up.railway.app',
    endpoints: {
      orders: '/user/orders',
      products: '/user/products',
      members: '/user/members'
    }
  };

  // å…¨åŸŸè®Šæ•¸
  let ordersData = [];
  let filteredOrders = [];
  let productsData = [];
  let membersData = [];
  let currentEditOrder = null;
  let currentAdminLevel = null; // ç•¶å‰ç®¡ç†å“¡æ¬Šé™ç­‰ç´š

  // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
  function showMessage(message, type = 'success') {
    const messageElement = document.getElementById('statusMessage');
    messageElement.textContent = message;
    messageElement.className = `status-message ${type}`;
    messageElement.style.display = 'block';

    if (type !== 'loading') {
      setTimeout(() => {
        messageElement.style.display = 'none';
      }, 4000);
    }
  }

  // è¼‰å…¥æ‰€æœ‰è¨‚å–®è³‡æ–™
  async function loadOrders() {
    try {
      showMessage('è¼‰å…¥è¨‚å–®è³‡æ–™ä¸­...', 'loading');
      
      // å…ˆè¼‰å…¥æœƒå“¡åˆ—è¡¨å’Œå•†å“åˆ—è¡¨
      await Promise.all([loadMembers(), loadProducts()]);
      
      // ç›´æ¥å‘¼å«ç®¡ç†å“¡APIç²å–æ‰€æœ‰è¨‚å–®è³‡æ–™
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('adminToken') || ''}`
        }
      });

      if (response.ok) {
        const result = await response.json();
        const allOrderData = result.data || result || [];
        
        // å°‡è¨‚å–®è³‡æ–™æŒ‰order_idåˆ†çµ„ï¼Œè™•ç†åŒ…å«è¨‚å–®è©³ç´°çš„çµæ§‹
        const ordersByOrderId = {};
        
        allOrderData.forEach(item => {
          const orderId = item.order_id;
          
          if (!ordersByOrderId[orderId]) {
            // å‰µå»ºæ–°çš„è¨‚å–®è¨˜éŒ„
            ordersByOrderId[orderId] = {
              order_id: orderId,
              member_id: item.member_id,
              create_at: item.create_at || new Date().toISOString(),
              orderDetails: []
            };
          }
          
          // å¦‚æœæœ‰å•†å“è³‡è¨Šï¼Œæ·»åŠ åˆ°è¨‚å–®æ˜ç´°ä¸­
          if (item.product_id) {
            ordersByOrderId[orderId].orderDetails.push({
              order_id: orderId,
              product_id: item.product_id,
              quantity: item.quantity || 1,
              price: item.price || 0
            });
          }
        });

        ordersData = Object.values(ordersByOrderId);
        filteredOrders = [...ordersData];
        renderOrdersGrid();
        updateStats();
        showMessage(`è¼‰å…¥å®Œæˆï¼Œå…± ${ordersData.length} ç­†è¨‚å–®`, 'success');
      } else {
        throw new Error(`HTTP ${response.status}`);
      }
    } catch (error) {
      console.error('è¼‰å…¥è¨‚å–®è³‡æ–™éŒ¯èª¤:', error);
      
      // è¼‰å…¥æ¸¬è©¦è³‡æ–™
      loadTestData();
      showMessage('é€£æ¥å¾Œç«¯å¤±æ•—ï¼Œè¼‰å…¥æ¸¬è©¦è³‡æ–™', 'error');
    }
  }

  // è¼‰å…¥æ‰€æœ‰è¨‚å–®çš„è©³ç´°è³‡æ–™
  async function loadAllOrderDetails() {
    for (let order of ordersData) {
      try {
        // ä½¿ç”¨æ–°çš„APIçµæ§‹ï¼šGET /user/orders?order_id=123 è¿”å›è¨‚å–®æ˜ç´°
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}?order_id=${order.order_id}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const result = await response.json();
          // æ ¹æ“šæ–°çš„APIï¼Œé€™è£¡ç›´æ¥è¿”å›order_detailé™£åˆ—
          order.orderDetails = result.data || [];
        }
      } catch (error) {
        console.warn(`ç„¡æ³•è¼‰å…¥è¨‚å–® ${order.order_id} çš„è©³ç´°è³‡æ–™:`, error);
        order.orderDetails = [];
      }
    }
  }

  // è¼‰å…¥ç‰¹å®šæœƒå“¡çš„è¨‚å–®
  async function loadOrdersByMember(memberId) {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}?member_id=${memberId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        return result.data || [];
      } else {
        throw new Error('ç„¡æ³•è¼‰å…¥æœƒå“¡è¨‚å–®è³‡æ–™');
      }
    } catch (error) {
      console.error(`è¼‰å…¥æœƒå“¡ ${memberId} è¨‚å–®è³‡æ–™éŒ¯èª¤:`, error);
      return [];
    }
  }

  // è¼‰å…¥æœƒå“¡è³‡æ–™
  async function loadMembers() {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.members}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        membersData = result.data || result || [];
        renderMemberFilter();
      }
    } catch (error) {
      console.error('è¼‰å…¥æœƒå“¡è³‡æ–™éŒ¯èª¤:', error);
      // ä½¿ç”¨æ¸¬è©¦æœƒå“¡è³‡æ–™
      membersData = [
        { member_id: 111, name: 'å¼µå°æ˜' },
        { member_id: 222, name: 'æå°ç¾' },
        { member_id: 333, name: 'ç‹å¤§è¯' }
      ];
      renderMemberFilter();
    }
  }

  // è¼‰å…¥å•†å“è³‡æ–™
  async function loadProducts() {
    try {
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.products}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        productsData = result.data || result || [];
      }
    } catch (error) {
      console.error('è¼‰å…¥å•†å“è³‡æ–™éŒ¯èª¤:', error);
      // ä½¿ç”¨æ¸¬è©¦å•†å“è³‡æ–™
      productsData = [
        { product_id: 1, name: 'iPhone 15 Pro', price: 39900 },
        { product_id: 2, name: 'ç„¡ç·šè€³æ©Ÿ', price: 2990 },
        { product_id: 3, name: 'é‹å‹•é‹', price: 3500 },
        { product_id: 4, name: 'å’–å•¡æ©Ÿ', price: 12800 }
      ];
    }
  }

  // è¼‰å…¥æ¸¬è©¦è³‡æ–™
  function loadTestData() {
    ordersData = [
      {
        order_id: 1001,
        member_id: 111,
        create_at: '2024-01-15T10:30:00',
        orderDetails: [
          { order_id: 1001, product_id: 1, quantity: 1, price: 39900 },
          { order_id: 1001, product_id: 2, quantity: 2, price: 2990 }
        ]
      },
      {
        order_id: 1002,
        member_id: 222,
        create_at: '2024-01-16T14:20:00',
        orderDetails: [
          { order_id: 1002, product_id: 3, quantity: 1, price: 3500 },
          { order_id: 1002, product_id: 4, quantity: 1, price: 12800 }
        ]
      },
      {
        order_id: 1003,
        member_id: 111,
        create_at: '2024-01-17T09:15:00',
        orderDetails: [
          { order_id: 1003, product_id: 1, quantity: 2, price: 39900 }
        ]
      }
    ];
    filteredOrders = [...ordersData];
    renderOrdersGrid();
    updateStats();
  }

  // æ¸²æŸ“è¨‚å–®ç¶²æ ¼
  function renderOrdersGrid() {
    const grid = document.getElementById('ordersGrid');
    
    if (filteredOrders.length === 0) {
      grid.innerHTML = `
        <div class="no-data">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</div>
      `;
      return;
    }

    grid.innerHTML = filteredOrders.map(order => {
      const member = getMemberInfo(order.member_id);
      const orderTotal = calculateOrderTotal(order);
      const itemCount = order.orderDetails?.length || 0;
      
      const orderItemsHtml = (order.orderDetails || []).map(detail => {
        const product = getProductInfo(detail.product_id);
        const itemTotal = detail.price * detail.quantity;
        return `
          <div class="order-item">
            <div class="item-info">
              <div class="item-name">${product.name}</div>
              <div class="item-price">å–®åƒ¹: NT$ ${formatPrice(detail.price)}</div>
            </div>
            <div class="item-quantity">x${detail.quantity}</div>
            <div style="text-align: right; font-weight: bold; color: #e74c3c; min-width: 100px;">
              NT$ ${formatPrice(itemTotal)}
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-info">
              <div class="order-id">è¨‚å–® #${order.order_id}</div>
              <div class="order-date">${formatDate(order.create_at)}</div>
            </div>
            <div class="order-status">å·²å®Œæˆ</div>
          </div>
          <div class="order-body">
            <div class="member-section">
              <div class="member-info">${member.name}</div>
              <div class="member-id">æœƒå“¡ID: ${order.member_id}</div>
            </div>
            
            <div class="order-items">
              <div class="items-title">
                <span>ğŸ“¦</span>
                è¨‚å–®æ˜ç´° (${itemCount} é …å•†å“)
              </div>
              ${orderItemsHtml}
            </div>
            
            <div class="order-summary">
              <div class="summary-row">
                <span>å•†å“å°è¨ˆ:</span>
                <span>NT$ ${formatPrice(orderTotal)}</span>
              </div>
              <div class="summary-row">
                <span>é‹è²»:</span>
                <span>NT$ 0</span>
              </div>
              <div class="summary-row">
                <span>è¨‚å–®ç¸½è¨ˆ:</span>
                <span>NT$ ${formatPrice(orderTotal)}</span>
              </div>
            </div>
            
            <div class="order-actions">
              <button class="btn btn-primary btn-sm" onclick="editOrder(${order.order_id})">
                âœï¸ ç·¨è¼¯
              </button>
              <button class="btn btn-success btn-sm" onclick="viewOrderDetails(${order.order_id})">
                ğŸ‘ï¸ è©³ç´°
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.order_id})">
                ğŸ—‘ï¸ åˆªé™¤
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // æ¸²æŸ“æœƒå“¡ç¯©é¸å™¨
  function renderMemberFilter() {
    const select = document.getElementById('memberFilter');
    const currentValue = select.value;
    
    select.innerHTML = '<option value="">æ‰€æœ‰æœƒå“¡</option>' +
      membersData.map(member => 
        `<option value="${member.member_id}">æœƒå“¡${member.member_id} - ${member.name || ''}</option>`
      ).join('');
    
    select.value = currentValue;
  }

  // å–å¾—æœƒå“¡è³‡è¨Š
  function getMemberInfo(memberId) {
    const member = membersData.find(m => m.member_id === memberId);
    return member || { name: `æœƒå“¡${memberId}`, member_id: memberId };
  }

  // å–å¾—å•†å“è³‡è¨Š
  function getProductInfo(productId) {
    const product = productsData.find(p => p.product_id === productId);
    return product || { name: `å•†å“${productId}`, price: 0 };
  }

  // è¨ˆç®—è¨‚å–®ç¸½é‡‘é¡
  function calculateOrderTotal(order) {
    if (!order.orderDetails) return 0;
    return order.orderDetails.reduce((total, detail) => {
      return total + (detail.price * detail.quantity);
    }, 0);
  }

  // æ ¼å¼åŒ–åƒ¹æ ¼
  function formatPrice(price) {
    return new Intl.NumberFormat('zh-TW').format(price);
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  function formatDate(dateString) {
    if (!dateString) return 'æœªçŸ¥';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW');
  }

  // æ›´æ–°çµ±è¨ˆè³‡æ–™
  function updateStats() {
    const totalOrders = ordersData.length;
    const totalRevenue = ordersData.reduce((sum, order) => sum + calculateOrderTotal(order), 0);
    const uniqueCustomers = new Set(ordersData.map(order => order.member_id)).size;
    const avgOrderValue = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;

    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('totalRevenue').textContent = formatPrice(totalRevenue);
    document.getElementById('totalCustomers').textContent = uniqueCustomers;
    document.getElementById('avgOrderValue').textContent = formatPrice(avgOrderValue);
  }

  // æœå°‹è¨‚å–®
  function searchOrders() {
    const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
    applyFilters();
  }

  // ä¾æœƒå“¡ç¯©é¸
  function filterByMember() {
    applyFilters();
  }

  // ä¾æ—¥æœŸç¯©é¸
  function filterByDate() {
    applyFilters();
  }

  // æ‡‰ç”¨æ‰€æœ‰ç¯©é¸
  function applyFilters() {
    const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
    const memberFilter = document.getElementById('memberFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;

    filteredOrders = ordersData.filter(order => {
      // æœå°‹ç¯©é¸
      const matchesSearch = !searchTerm || 
        order.order_id.toString().includes(searchTerm) ||
        order.member_id.toString().includes(searchTerm);

      // æœƒå“¡ç¯©é¸
      const matchesMember = !memberFilter || 
        order.member_id.toString() === memberFilter;

      // æ—¥æœŸç¯©é¸
      let matchesDate = true;
      if (dateFilter && order.create_at) {
        const orderDate = new Date(order.create_at);
        const now = new Date();
        
        switch (dateFilter) {
          case 'today':
            matchesDate = orderDate.toDateString() === now.toDateString();
            break;
          case 'week':
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            matchesDate = orderDate >= weekAgo;
            break;
          case 'month':
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            matchesDate = orderDate >= monthAgo;
            break;
        }
      }

      return matchesSearch && matchesMember && matchesDate;
    });

    renderOrdersGrid();
    showMessage(`æ‰¾åˆ° ${filteredOrders.length} ç­†ç¬¦åˆæ¢ä»¶çš„è¨‚å–®`, 'success');
  }

  // é‡æ–°æ•´ç†è¨‚å–®è³‡æ–™
  function refreshOrders() {
    document.getElementById('orderSearchInput').value = '';
    document.getElementById('memberFilter').value = '';
    document.getElementById('dateFilter').value = '';
    loadOrders();
  }

  // ç·¨è¼¯è¨‚å–®
  function editOrder(orderId) {

    // æª¢æŸ¥æ¬Šé™
    if (!checkOperationPermission()) {
      return;
    }

    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    currentEditOrder = order;
    
    document.getElementById('editOrderId').value = order.order_id;
    document.getElementById('editMemberId').value = order.member_id;
    
    // æ ¼å¼åŒ–æ—¥æœŸç‚º datetime-local æ ¼å¼
    if (order.create_at) {
      const date = new Date(order.create_at);
      const formatted = date.toISOString().slice(0, 16);
      document.getElementById('editOrderDate').value = formatted;
    }
    
    // æ¸²æŸ“è¨‚å–®æ˜ç´°
    renderEditOrderDetails(order.orderDetails || []);
    
    document.getElementById('editModal').style.display = 'flex';
  }

  // æ¸²æŸ“ç·¨è¼¯æ¨¡æ…‹æ¡†ä¸­çš„è¨‚å–®æ˜ç´°
  function renderEditOrderDetails(orderDetails) {
    const container = document.getElementById('editOrderDetails');
    
    if (orderDetails.length === 0) {
      container.innerHTML = '<div style="text-align: center; color: #666;">æ­¤è¨‚å–®æ²’æœ‰å•†å“æ˜ç´°</div>';
      return;
    }
    
    container.innerHTML = orderDetails.map((detail, index) => {
      const product = getProductInfo(detail.product_id);
      return `
        <div class="detail-item">
          <div style="flex: 1;">
            <strong>${product.name}</strong><br>
            <small>å•†å“ID: ${detail.product_id}</small>
          </div>
          <div style="text-align: center;">
            <label>æ•¸é‡:</label>
            <input type="number" value="${detail.quantity}" min="1" 
                   onchange="updateDetailQuantity(${index}, this.value)"
                   style="width: 60px; margin-left: 5px;">
          </div>
          <div style="text-align: right;">
            NT$ ${formatPrice(detail.price)}
          </div>
        </div>
      `;
    }).join('');
  }

  // æ›´æ–°è¨‚å–®æ˜ç´°æ•¸é‡
  function updateDetailQuantity(index, newQuantity) {

    // æª¢æŸ¥æ¬Šé™
    if (!checkOperationPermission()) {
      return;
    }

    if (currentEditOrder && currentEditOrder.orderDetails[index]) {
      currentEditOrder.orderDetails[index].quantity = parseInt(newQuantity);
    }
  }

  // é—œé–‰ç·¨è¼¯æ¨¡æ…‹æ¡†
  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditOrder = null;
  }

  // æ›´æ–°è¨‚å–®
  async function updateOrder(event) {

    // æª¢æŸ¥æ¬Šé™
    if (!checkOperationPermission()) {
      return;
    }

    event.preventDefault();
    
    if (!currentEditOrder) return;
    
    try {
      showMessage('æ›´æ–°è¨‚å–®ä¸­...', 'loading');
      
      const updateData = {
        order_id: currentEditOrder.order_id,
        member_id: currentEditOrder.member_id,
        create_at: document.getElementById('editOrderDate').value,
        orderDetails: currentEditOrder.orderDetails
      };
      
      const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      });

      if (response.ok) {
        closeEditModal();
        loadOrders(); // é‡æ–°è¼‰å…¥è³‡æ–™
        showMessage('è¨‚å–®æ›´æ–°æˆåŠŸ', 'success');
      } else {
        throw new Error('æ›´æ–°å¤±æ•—');
      }
    } catch (error) {
      console.error('æ›´æ–°è¨‚å–®éŒ¯èª¤:', error);
      showMessage('æ›´æ–°è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    }
  }

  // æŸ¥çœ‹è¨‚å–®è©³ç´°
  function viewOrderDetails(orderId) {
    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    const member = getMemberInfo(order.member_id);
    const orderTotal = calculateOrderTotal(order);
    
    let detailsText = `è¨‚å–®ç·¨è™Ÿ: ${order.order_id}\n`;
    detailsText += `æœƒå“¡: ${member.name} (ID: ${order.member_id})\n`;
    detailsText += `è¨‚å–®æ—¥æœŸ: ${formatDate(order.create_at)}\n\n`;
    detailsText += `å•†å“æ˜ç´°:\n`;
    
    (order.orderDetails || []).forEach(detail => {
      const product = getProductInfo(detail.product_id);
      detailsText += `- ${product.name} x${detail.quantity} = NT$ ${formatPrice(detail.price * detail.quantity)}\n`;
    });
    
    detailsText += `\nè¨‚å–®ç¸½è¨ˆ: NT$ ${formatPrice(orderTotal)}`;
    
    alert(detailsText);
  }

  // åˆªé™¤è¨‚å–®
  async function deleteOrder(orderId) {

    // æª¢æŸ¥æ¬Šé™
    if (!checkOperationPermission()) {
      return;
    }

    const order = ordersData.find(o => o.order_id === orderId);
    if (!order) return;
    
    if (confirm(`ç¢ºå®šè¦åˆªé™¤è¨‚å–® #${orderId} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
      try {
        showMessage('åˆªé™¤è¨‚å–®ä¸­...', 'loading');
        
        const deleteData = {
          order_id: orderId
        };
        
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.orders}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(deleteData)
        });

        if (response.ok) {
          loadOrders(); // é‡æ–°è¼‰å…¥è³‡æ–™
          showMessage('è¨‚å–®åˆªé™¤æˆåŠŸ', 'success');
        } else {
          throw new Error('åˆªé™¤å¤±æ•—');
        }
      } catch (error) {
        console.error('åˆªé™¤è¨‚å–®éŒ¯èª¤:', error);
        showMessage('åˆªé™¤è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
      }
    }
  }

  // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
  function checkAdminAuth() {
    const adminToken = localStorage.getItem('adminToken');
    if (!adminToken) {
      showMessage('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ', 'error');
      setTimeout(() => {
        window.location.href = 'admin-login.html';
      }, 2000);
      return false;
    }

    // ç²å–ç®¡ç†å“¡æ¬Šé™ç­‰ç´š
    const adminInfo = localStorage.getItem('adminInfo');
    const adminLevel = localStorage.getItem('adminLevel');

    console.log('localStorageå…§å®¹æª¢æŸ¥:');
    console.log('adminToken:', adminToken);
    console.log('adminInfo:', adminInfo);
    console.log('adminLevel:', adminLevel);

    // å˜—è©¦å¤šç¨®æ–¹å¼ç²å–ç®¡ç†å“¡ç­‰ç´š
    if (adminInfo) {
      try {
        const info = JSON.parse(adminInfo);
        console.log('è§£æçš„adminInfo:', info);
        currentAdminLevel = info.level !== undefined ? info.level : (info.adminLevel !== undefined ? info.adminLevel : null);
      } catch (error) {
        console.warn('ç„¡æ³•è§£æç®¡ç†å“¡è³‡è¨Š:', error);
        currentAdminLevel = null;
      }
    }

    // å¦‚æœadminInfoæ²’æœ‰levelï¼Œå˜—è©¦å¾å–®ç¨çš„adminLevelé …ç›®å–å¾—
    if (currentAdminLevel === null && adminLevel !== null) {
      currentAdminLevel = parseInt(adminLevel);
    }

    // å¦‚æœé‚„æ˜¯æ²’æœ‰ï¼Œæš«æ™‚è¨­ç‚ºæ¸¬è©¦ç­‰ç´šï¼ˆå¯ç§»é™¤ï¼‰
    if (currentAdminLevel === null) {
      console.warn('ç„¡æ³•å¾localStorageç²å–ç®¡ç†å“¡ç­‰ç´šï¼Œè«‹æª¢æŸ¥ç™»å…¥æµç¨‹');
      // è‡¨æ™‚è¨­ç½®ç‚ºæ¸¬è©¦ç”¨ï¼ˆå¯¦éš›ä½¿ç”¨æ™‚æ‡‰ç§»é™¤ï¼‰
      currentAdminLevel = 0; // æš«æ™‚è¨­ç‚ºè¶…ç´šç®¡ç†å“¡ä»¥ä¾¿æ¸¬è©¦
      showMessage('è­¦å‘Šï¼šç„¡æ³•ç¢ºèªç®¡ç†å“¡ç­‰ç´šï¼Œæš«æ™‚è¨­ç‚ºè¶…ç´šç®¡ç†å“¡', 'error');
    }

    console.log('æœ€çµ‚è¨­å®šçš„currentAdminLevel:', currentAdminLevel);

    return true;
  }

  // æª¢æŸ¥æ“ä½œæ¬Šé™
  function checkOperationPermission() {
    if (currentAdminLevel === null) {
      showMessage('ç„¡æ³•ç¢ºèªç®¡ç†å“¡æ¬Šé™ç­‰ç´š', 'error');
      return false;
    }

    // åªæœ‰ç­‰ç´š 0-2 çš„ç®¡ç†å“¡å¯ä»¥é€²è¡Œç·¨è¼¯å’Œåˆªé™¤æ“ä½œ
    if (currentAdminLevel > 2) {
      showMessage('æ¬Šé™ä¸è¶³', 'error');
      return false;
    }

    return true;
  }

  // æœå°‹è¼¸å…¥æ¡†å›è»Šäº‹ä»¶
  document.getElementById('orderSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      searchOrders();
    }
  });

  // è¡¨å–®æäº¤äº‹ä»¶
  document.getElementById('editForm').addEventListener('submit', updateOrder);

  // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeEditModal();
    }
  });

  // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥æ¬Šé™ä¸¦è¼‰å…¥è³‡æ–™
  window.addEventListener('load', function() {
    if (checkAdminAuth()) {
      loadProducts();
      loadMembers();
      loadOrders();
    }
  });

  // éŒ¯èª¤è™•ç†
  window.addEventListener('error', function(e) {
    console.error('é é¢éŒ¯èª¤:', e.error);
  });
</script>
</body>
</html>