<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員登入</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .title {
      font-size: 2.2em;
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .subtitle {
      color: #666;
      font-size: 1em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(45deg, #4facfe, #00f2fe);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .login-btn:hover {
      background: linear-gradient(45deg, #43a3f5, #00e8f5);
      transform: translateY(-1px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .login-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .back-link {
      display: block;
      text-align: center;
      color: #666;
      text-decoration: none;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .back-link:hover {
      background: #f8f9fa;
      color: #4facfe;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      text-align: center;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }
      
      .title {
        font-size: 1.8em;
      }
    }
  </style>
</head>
<body>
<div class="login-container">
  <div class="header">
    <h1 class="title">會員登入</h1>
    <p class="subtitle">歡迎回來！請登入您的帳戶</p>
  </div>

  <div id="message" class="message"></div>

  <form id="loginForm">
    <div class="form-group">
      <label class="form-label" for="email">電子郵件</label>
      <input type="email" class="form-input" id="email" name="email" required 
             placeholder="請輸入您的電子郵件">
    </div>

    <div class="form-group">
      <label class="form-label" for="password">密碼</label>
      <input type="password" class="form-input" id="password" name="password" required 
             placeholder="請輸入您的密碼">
    </div>

    <button type="submit" class="login-btn" id="loginBtn">
      登入
    </button>
  </form>

  <a href="index.html" class="back-link">← 返回首頁</a>
</div>

<script>
// API 設定
const API_CONFIG = {
  loginURL: 'https://intellij-project1-production.up.railway.app/member/login'
};

// 顯示訊息
function showMessage(type, message) {
  const messageElement = document.getElementById('message');
  messageElement.className = `message ${type}`;
  messageElement.textContent = message;
  messageElement.style.display = 'block';

  if (type !== 'loading') {
    setTimeout(() => {
      messageElement.style.display = 'none';
    }, 4000);
  }
}

// 處理表單提交
document.getElementById('loginForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const loginBtn = document.getElementById('loginBtn');

  // 基本驗證
  if (!email || !password) {
    showMessage('error', '請填寫所有必填欄位');
    return;
  }

  // 禁用按鈕並顯示載入狀態
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<span class="loading-spinner"></span>登入中...';
  showMessage('loading', '正在驗證您的帳戶...');

  try {
    // 準備登入資料
    const loginData = {
      email: email,
      password: password
    };

    console.log('發送登入請求到:', API_CONFIG.loginURL);
    console.log('登入資料:', { email: email, password: '[隱藏]' });

    // 發送登入請求
    const response = await fetch(API_CONFIG.loginURL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      mode: 'cors',
      credentials: 'omit',
      body: JSON.stringify(loginData)
    });

    console.log('登入回應狀態:', response.status);

    const responseText = await response.text();
    console.log('登入原始回應:', responseText);

    if (response.ok) {
      let result;
      try {
        result = JSON.parse(responseText);
        console.log('登入解析後回應:', result);
      } catch (parseError) {
        console.error('JSON解析失敗:', parseError);
        throw new Error('伺服器回應格式錯誤');
      }

      // 檢查登入是否成功
      if (result.status === 200 && result.data && result.data.member_id) {
        // 登入成功
        const memberData = result.data;
        
        // 儲存會員資訊到 localStorage
        localStorage.setItem('member_id', memberData.member_id.toString());
        localStorage.setItem('memberName', memberData.name || '');
        localStorage.setItem('memberEmail', memberData.email || '');
        localStorage.setItem('authToken', memberData.token || 'authenticated');

        console.log('✅ 登入成功，會員ID:', memberData.member_id);
        
        showMessage('success', '登入成功！正在跳轉...');

        // 跳轉到會員後台
        setTimeout(() => {
          window.location.href = 'member-dashboard.html';
        }, 1500);

      } else {
        // 登入失敗
        const errorMessage = result.message || '登入失敗，請檢查帳號密碼';
        console.log('❌ 登入失敗:', errorMessage);
        showMessage('error', errorMessage);
      }

    } else {
      // HTTP錯誤
      console.error('HTTP錯誤:', response.status, responseText);
      
      let errorMessage = `登入失敗 (HTTP ${response.status})`;
      try {
        const errorResult = JSON.parse(responseText);
        if (errorResult.message) {
          errorMessage = errorResult.message;
        }
      } catch (e) {
        // 使用預設錯誤訊息
      }

      showMessage('error', errorMessage);
    }

  } catch (error) {
    console.error('登入錯誤:', error);
    
    let errorMessage = '登入失敗，請稍後再試';
    if (error.message.includes('Failed to fetch')) {
      errorMessage = '無法連接到伺服器，請檢查網路連線';
    } else if (error.message.includes('CORS')) {
      errorMessage = '伺服器連線問題，請聯繫管理員';
    }

    showMessage('error', errorMessage);

  } finally {
    // 恢復按鈕狀態
    loginBtn.disabled = false;
    loginBtn.innerHTML = '登入';
  }
});

// 頁面載入時檢查是否已登入
window.addEventListener('load', function() {
  const member_id = localStorage.getItem('member_id');
  if (member_id && member_id !== 'null') {
    console.log('檢測到已登入會員，跳轉到後台');
    window.location.href = 'member-dashboard.html';
  }
});
</script>
</body>
</html>